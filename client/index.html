<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —à–∫–æ–ª—ã - MARGARITA</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0; 
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        /* --- –≠–∫—Ä–∞–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ --- */
        #authScreen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        .auth-container {
            background: #fff;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 400px;
        }
        .auth-container h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .auth-tabs {
            display: flex;
            margin-bottom: 20px;
        }
        .auth-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: #f0f0f0;
            font-size: 1rem;
            transition: all 0.3s;
        }
        .auth-tab:first-child { border-radius: 10px 0 0 10px; }
        .auth-tab:last-child { border-radius: 0 10px 10px 0; }
        .auth-tab.active {
            background: linear-gradient(90deg, #667eea, #764ba2);
            color: #fff;
        }
        .auth-form { display: none; }
        .auth-form.active { display: block; }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }
        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        .auth-btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 10px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            color: #fff;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        .auth-error {
            color: #e74c3c;
            text-align: center;
            margin-top: 15px;
        }
        
        /* --- –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω --- */
        #mainScreen {
            display: none;
            flex-direction: column;
            min-height: 100vh;
            background: #f0f0f0;
        }
        .header {
            background: linear-gradient(90deg, #667eea, #764ba2);
            color: #fff;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header h1 { margin: 0; font-size: 1.5rem; }
        .header-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .logout-btn {
            padding: 8px 20px;
            border: 2px solid #fff;
            border-radius: 20px;
            background: transparent;
            color: #fff;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }
        .logout-btn:hover {
            background: #fff;
            color: #667eea;
        }
        
        .main-content {
            display: flex;
            flex: 1;
            padding: 20px;
            gap: 20px;
        }
        
        /* --- –ü–∞–Ω–µ–ª–∏ --- */
        .side-panel {
            width: 200px;
            background: #fff;
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .side-panel h3 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 1rem;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }
        .panel-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 500px;
            overflow-y: auto;
        }
        
        /* --- –ö–∞–Ω–≤–∞—Å --- */
        .canvas-container {
            flex: 1;
            background: #fff;
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }
        .canvas-toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        .toolbar-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }
        .toolbar-btn.primary {
            background: linear-gradient(90deg, #0074D9, #2ECC40);
            color: #fff;
        }
        .toolbar-btn.secondary {
            background: linear-gradient(90deg, #FF851B, #FFDC00);
            color: #222;
        }
        .toolbar-btn.danger {
            background: linear-gradient(90deg, #FF4136, #FF851B);
            color: #fff;
        }
        .toolbar-btn:hover { transform: scale(1.05); }
        .toolbar-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        
        .map-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
            padding: 8px 15px;
            background: #f0f0f0;
            border-radius: 20px;
        }
        .map-toggle label { cursor: pointer; font-size: 0.9rem; }
        
        #canvas {
            width: 900px;
            height: 600px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            cursor: crosshair;
            background: #fafafa;
        }
        
        /* --- –≠–ª–µ–º–µ–Ω—Ç—ã —Å–ø–∏—Å–∫–æ–≤ --- */
        .floor-item, .sensor-item, .camera-item {
            padding: 10px 12px;
            margin-bottom: 8px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        .floor-item {
            background: #f7f7f7;
            border: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .floor-item:hover { background: #e8e8e8; }
        .floor-item.active {
            background: #d0e8ff;
            border-color: #0074D9;
        }
        .floor-item .floor-btns {
            display: none;
            gap: 5px;
        }
        .floor-item:hover .floor-btns { display: flex; }
        .floor-btn {
            width: 24px;
            height: 24px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            color: #fff;
        }
        .floor-btn.edit { background: #0074D9; }
        .floor-btn.delete { background: #FF4136; }
        
        .sensor-item {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: #fff;
            font-weight: 500;
        }
        .sensor-item:hover { transform: scale(1.02); }
        .sensor-item.placed {
            background: linear-gradient(135deg, #11998e, #38ef7d);
            opacity: 0.8;
        }
        .sensor-item .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 20px;
            height: 20px;
            border: none;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            color: #fff;
            cursor: pointer;
            font-size: 12px;
            display: none;
        }
        .sensor-item:hover .remove-btn { display: block; }
        
        .camera-item {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: #fff;
            font-weight: 500;
        }
        .camera-item.placed {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
        }
        .camera-item .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 20px;
            height: 20px;
            border: none;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            color: #fff;
            cursor: pointer;
            font-size: 12px;
            display: none;
        }
        .camera-item:hover .remove-btn { display: block; }
        
        /* --- –°–µ–∫—Ü–∏–∏ –¥–∞—Ç—á–∏–∫–æ–≤/–∫–∞–º–µ—Ä --- */
        .section-title {
            font-size: 0.85rem;
            color: #666;
            margin: 15px 0 10px 0;
            padding-bottom: 5px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        /* --- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤–∏–¥–µ–æ --- */
        .video-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }
        .video-modal.active {
            display: flex;
        }
        .video-modal-content {
            background: #1a1a2e;
            border-radius: 15px;
            padding: 20px;
            max-width: 90%;
            max-height: 90%;
            position: relative;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        .video-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            color: #fff;
        }
        .video-modal-header h3 {
            margin: 0;
            font-size: 1.3rem;
        }
        .video-modal-close {
            background: #e74c3c;
            border: none;
            color: #fff;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            transition: transform 0.2s;
        }
        .video-modal-close:hover {
            transform: scale(1.1);
        }
        .video-container {
            position: relative;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
        }
        .video-frame {
            max-width: 800px;
            max-height: 600px;
            display: block;
        }
        .video-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding: 10px 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            color: #fff;
        }
        .video-stat {
            text-align: center;
        }
        .video-stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #2ecc71;
        }
        .video-stat-label {
            font-size: 0.8rem;
            color: #aaa;
        }
        .video-no-frame {
            width: 640px;
            height: 480px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #666;
            font-size: 1.2rem;
        }
        .watch-btn {
            background: linear-gradient(90deg, #3498db, #2980b9);
            border: none;
            color: #fff;
            padding: 4px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.75rem;
            margin-top: 5px;
        }
        .watch-btn:hover {
            background: linear-gradient(90deg, #2980b9, #1a5276);
        }
    </style>
</head>
<body>

<!-- –≠–∫—Ä–∞–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
<div id="authScreen">
    <div class="auth-container">
        <h1>üè´ MARGARITA</h1>
        <div class="auth-tabs">
            <button class="auth-tab active" data-tab="login">–í—Ö–æ–¥</button>
            <button class="auth-tab" data-tab="register">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
        </div>
        
        <form id="loginForm" class="auth-form active">
            <div class="form-group">
                <label>ID –®–∫–æ–ª—ã</label>
                <input type="text" id="loginSchoolId" placeholder="school_1" required>
            </div>
            <div class="form-group">
                <label>–ü–∞—Ä–æ–ª—å</label>
                <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
            </div>
            <button type="submit" class="auth-btn">–í–æ–π—Ç–∏</button>
            <div class="auth-error" id="loginError"></div>
        </form>
        
        <form id="registerForm" class="auth-form">
            <div class="form-group">
                <label>ID –®–∫–æ–ª—ã (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π)</label>
                <input type="text" id="regSchoolId" placeholder="school_1" required>
            </div>
            <div class="form-group">
                <label>–ù–∞–∑–≤–∞–Ω–∏–µ —à–∫–æ–ª—ã</label>
                <input type="text" id="regSchoolName" placeholder="–®–∫–æ–ª–∞ ‚Ññ1">
            </div>
            <div class="form-group">
                <label>–ü–∞—Ä–æ–ª—å</label>
                <input type="password" id="regPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
            </div>
            <button type="submit" class="auth-btn">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
            <div class="auth-error" id="registerError"></div>
        </form>
    </div>
</div>

<!-- –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω -->
<div id="mainScreen">
    <header class="header">
        <h1>üè´ MARGARITA - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —à–∫–æ–ª—ã</h1>
        <div class="header-info">
            <span id="schoolName">–®–∫–æ–ª–∞</span>
            <button class="logout-btn" id="logoutBtn">–í—ã–π—Ç–∏</button>
        </div>
    </header>
    
    <div class="main-content">
        <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å: –≠—Ç–∞–∂–∏ -->
        <div class="side-panel">
            <h3>üìê –≠—Ç–∞–∂–∏</h3>
            <ul id="floorList" class="panel-list"></ul>
            <button class="toolbar-btn primary" id="newFloorBtn" style="width:100%; margin-top:10px;">+ –ù–æ–≤—ã–π —ç—Ç–∞–∂</button>
        </div>
        
        <!-- –¶–µ–Ω—Ç—Ä: –ö–∞–Ω–≤–∞—Å -->
        <div class="canvas-container">
            <div class="canvas-toolbar">
                <button class="toolbar-btn primary" id="drawModeBtn">‚úèÔ∏è –†–∏—Å–æ–≤–∞—Ç—å</button>
                <button class="toolbar-btn secondary" id="saveBtn" disabled>üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                
                <div class="map-toggle">
                    <input type="checkbox" id="heatmapToggle" checked>
                    <label for="heatmapToggle">üå°Ô∏è –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞</label>
                </div>
                <div class="map-toggle">
                    <input type="checkbox" id="densityToggle" checked>
                    <label for="densityToggle">üë• –ü–ª–æ—Ç–Ω–æ—Å—Ç—å</label>
                </div>
            </div>
            <canvas id="canvas" width="900" height="600"></canvas>
        </div>
        
        <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å: –î–∞—Ç—á–∏–∫–∏ –∏ –ö–∞–º–µ—Ä—ã -->
        <div class="side-panel">
            <h3>üì° –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</h3>
            
            <div class="section-title">üå°Ô∏è –î–∞—Ç—á–∏–∫–∏ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã</div>
            <ul id="sensorsList" class="panel-list"></ul>
            
            <div class="section-title">üìπ –ö–∞–º–µ—Ä—ã</div>
            <ul id="camerasList" class="panel-list"></ul>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤–∏–¥–µ–æ —Å –∫–∞–º–µ—Ä—ã -->
<div id="videoModal" class="video-modal">
    <div class="video-modal-content">
        <div class="video-modal-header">
            <h3>üìπ <span id="videoModalCameraId">–ö–∞–º–µ—Ä–∞</span></h3>
            <button class="video-modal-close" id="closeVideoModal">‚úï</button>
        </div>
        <div class="video-container">
            <img id="videoFrame" class="video-frame" alt="Video Stream">
            <div id="videoNoFrame" class="video-no-frame">
                ‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫–∞...
            </div>
        </div>
        <div class="video-stats">
            <div class="video-stat">
                <div class="video-stat-value" id="videoPersonCount">0</div>
                <div class="video-stat-label">–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –ª—é–¥–µ–π</div>
            </div>
            <div class="video-stat">
                <div class="video-stat-value" id="videoFps">-</div>
                <div class="video-stat-label">–û–±–Ω–æ–≤–ª–µ–Ω–∏–π/—Å–µ–∫</div>
            </div>
            <div class="video-stat">
                <div class="video-stat-value" id="videoLastUpdate">-</div>
                <div class="video-stat-label">–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</div>
            </div>
        </div>
    </div>
</div>

<script>
// --- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ---
const API_URL = 'http://localhost:5000';
let JWT_TOKEN = '';
let SCHOOL_ID = '';
let SCHOOL_NAME = '';
let socket = null;

// --- –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ---
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

let points = [];
let savedFloors = [];
let currentViewFloorIdx = null;
let editingFloorIdx = null;
let drawMode = false;
let draggingIdx = null;
let selectedIdx = null;
let offset = {x: 0, y: 0};

const RADIUS = 8;
const SENSOR_RADIUS = 14;
const CAMERA_RADIUS = 18;

// –î–∞–Ω–Ω—ã–µ –¥–∞—Ç—á–∏–∫–æ–≤ –∏ –∫–∞–º–µ—Ä
let sensorsData = {};
let camerasData = {};
let sensorPositions = {};
let cameraPositions = {};

// –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤
let draggingDevice = null;
let draggingDeviceType = null;
let draggingDeviceOffset = {x: 0, y: 0};

// --- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è ---
document.querySelectorAll('.auth-tab').forEach(tab => {
    tab.addEventListener('click', () => {
        document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab + 'Form').classList.add('active');
    });
});

document.getElementById('loginForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const schoolId = document.getElementById('loginSchoolId').value.trim();
    const password = document.getElementById('loginPassword').value;
    
    try {
        const resp = await fetch(`${API_URL}/login`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({school_id: schoolId, password: password})
        });
        const data = await resp.json();
        
        if (resp.ok) {
            JWT_TOKEN = data.token;
            SCHOOL_ID = data.school_id;
            SCHOOL_NAME = data.name || schoolId;
            localStorage.setItem('jwt_token', JWT_TOKEN);
            localStorage.setItem('school_id', SCHOOL_ID);
            localStorage.setItem('school_name', SCHOOL_NAME);
            showMainScreen();
        } else {
            document.getElementById('loginError').textContent = data.error || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞';
        }
    } catch (err) {
        document.getElementById('loginError').textContent = '–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω';
    }
});

document.getElementById('registerForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const schoolId = document.getElementById('regSchoolId').value.trim();
    const schoolName = document.getElementById('regSchoolName').value.trim();
    const password = document.getElementById('regPassword').value;
    
    try {
        const resp = await fetch(`${API_URL}/register`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({school_id: schoolId, name: schoolName, password: password})
        });
        const data = await resp.json();
        
        if (resp.ok) {
            JWT_TOKEN = data.token;
            SCHOOL_ID = data.school_id;
            SCHOOL_NAME = schoolName || schoolId;
            localStorage.setItem('jwt_token', JWT_TOKEN);
            localStorage.setItem('school_id', SCHOOL_ID);
            localStorage.setItem('school_name', SCHOOL_NAME);
            showMainScreen();
        } else {
            document.getElementById('registerError').textContent = data.error || '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏';
        }
    } catch (err) {
        document.getElementById('registerError').textContent = '–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω';
    }
});

document.getElementById('logoutBtn').addEventListener('click', () => {
    localStorage.clear();
    JWT_TOKEN = '';
    SCHOOL_ID = '';
    if (socket) socket.disconnect();
    document.getElementById('authScreen').style.display = 'flex';
    document.getElementById('mainScreen').style.display = 'none';
});

function apiHeaders() {
    return {'Authorization': 'Bearer ' + JWT_TOKEN, 'Content-Type': 'application/json'};
}

async function showMainScreen() {
    document.getElementById('authScreen').style.display = 'none';
    document.getElementById('mainScreen').style.display = 'flex';
    document.getElementById('schoolName').textContent = SCHOOL_NAME;
    
    // –ü–æ–¥–∫–ª—é—á–∞–µ–º WebSocket
    connectWebSocket();
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    await loadFloors();
    await loadSensorPositions();
    await loadCameraPositions();
    
    if (savedFloors.length > 0) {
        currentViewFloorIdx = 0;
        points = JSON.parse(JSON.stringify(savedFloors[0] || []));
    }
    
    renderFloorList();
    draw();
    updateSaveBtnState();
    fetchSensors();
    fetchCameras();
    
    setInterval(fetchSensors, 2000);
    setInterval(fetchCameras, 2000);
}

function connectWebSocket() {
    socket = io(API_URL);
    
    socket.on('connect', () => {
        console.log('WebSocket connected');
        socket.emit('subscribe', {school_id: SCHOOL_ID});
    });
    
    socket.on('camera_update', (data) => {
        if (data.school_id === SCHOOL_ID) {
            camerasData[data.camera_id] = {
                count: data.count,
                timestamp: data.timestamp
            };
            updateCamerasList();
            draw();
        }
    });
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞–¥—Ä–æ–≤ –¥–ª—è –≤–∏–¥–µ–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
    socket.on('camera_frame', (data) => {
        if (data.school_id === SCHOOL_ID && data.camera_id === currentWatchingCamera) {
            updateVideoFrame(data);
        }
    });
}

// --- API —Ñ—É–Ω–∫—Ü–∏–∏ ---
async function loadFloors() {
    try {
        const resp = await fetch(`${API_URL}/floors`, {headers: apiHeaders()});
        const data = await resp.json();
        savedFloors = data.floors && data.floors.length > 0 ? data.floors : [[]];
    } catch (e) {
        console.error('Error loading floors:', e);
        savedFloors = [[]];
    }
}

async function saveFloorsToServer() {
    try {
        await fetch(`${API_URL}/floors`, {
            method: 'POST',
            headers: apiHeaders(),
            body: JSON.stringify({floors: savedFloors})
        });
    } catch (e) {
        console.error('Error saving floors:', e);
    }
}

async function loadSensorPositions() {
    try {
        const resp = await fetch(`${API_URL}/sensor-positions`, {headers: apiHeaders()});
        const data = await resp.json();
        sensorPositions = {};
        if (data.positions) {
            for (const [floorIdx, sensors] of Object.entries(data.positions)) {
                sensorPositions[parseInt(floorIdx)] = sensors;
            }
        }
    } catch (e) {
        console.error('Error loading sensor positions:', e);
    }
}

async function saveSensorPositionsToServer(floorIdx) {
    try {
        await fetch(`${API_URL}/sensor-positions`, {
            method: 'POST',
            headers: apiHeaders(),
            body: JSON.stringify({floor_idx: floorIdx, positions: sensorPositions[floorIdx] || {}})
        });
    } catch (e) {
        console.error('Error saving sensor positions:', e);
    }
}

async function loadCameraPositions() {
    try {
        const resp = await fetch(`${API_URL}/camera-positions`, {headers: apiHeaders()});
        const data = await resp.json();
        cameraPositions = {};
        if (data.positions) {
            for (const [floorIdx, cameras] of Object.entries(data.positions)) {
                cameraPositions[parseInt(floorIdx)] = cameras;
            }
        }
    } catch (e) {
        console.error('Error loading camera positions:', e);
    }
}

async function saveCameraPositionsToServer(floorIdx) {
    try {
        await fetch(`${API_URL}/camera-positions`, {
            method: 'POST',
            headers: apiHeaders(),
            body: JSON.stringify({floor_idx: floorIdx, positions: cameraPositions[floorIdx] || {}})
        });
    } catch (e) {
        console.error('Error saving camera positions:', e);
    }
}

async function fetchSensors() {
    try {
        const resp = await fetch(`${API_URL}/sensor-data`, {headers: apiHeaders()});
        const data = await resp.json();
        if (data.data) {
            sensorsData = {};
            for (const [sensorId, queue] of Object.entries(data.data)) {
                const last = queue.length ? queue[queue.length - 1] : null;
                sensorsData[sensorId] = last ? {value: last.value, timestamp: last.timestamp} : null;
            }
            updateSensorsList();
            draw();
        }
    } catch (e) {
        console.error('Error fetching sensors:', e);
    }
}

async function fetchCameras() {
    try {
        const resp = await fetch(`${API_URL}/camera-data`, {headers: apiHeaders()});
        const data = await resp.json();
        if (data.data) {
            for (const [cameraId, camData] of Object.entries(data.data)) {
                camerasData[cameraId] = camData;
            }
            updateCamerasList();
            draw();
        }
    } catch (e) {
        console.error('Error fetching cameras:', e);
    }
}

// --- UI –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è ---
function updateSaveBtnState() {
    const saveBtn = document.getElementById('saveBtn');
    saveBtn.disabled = editingFloorIdx === null;
}

function renderFloorList() {
    const floorList = document.getElementById('floorList');
    floorList.innerHTML = '';
    
    savedFloors.forEach((floor, idx) => {
        const li = document.createElement('li');
        li.className = 'floor-item' + (currentViewFloorIdx === idx ? ' active' : '');
        li.innerHTML = `
            <span>–≠—Ç–∞–∂ ${idx + 1}</span>
            <div class="floor-btns">
                <button class="floor-btn edit" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úé</button>
                <button class="floor-btn delete" title="–£–¥–∞–ª–∏—Ç—å">‚úï</button>
            </div>
        `;
        
        li.querySelector('span').addEventListener('click', () => {
            points = JSON.parse(JSON.stringify(floor));
            currentViewFloorIdx = idx;
            editingFloorIdx = null;
            drawMode = false;
            document.getElementById('drawModeBtn').textContent = '‚úèÔ∏è –†–∏—Å–æ–≤–∞—Ç—å';
            renderFloorList();
            updateSensorsList();
            updateCamerasList();
            draw();
            updateSaveBtnState();
        });
        
        li.querySelector('.edit').addEventListener('click', (e) => {
            e.stopPropagation();
            points = JSON.parse(JSON.stringify(floor));
            currentViewFloorIdx = idx;
            editingFloorIdx = idx;
            drawMode = false;
            document.getElementById('drawModeBtn').textContent = '‚úèÔ∏è –†–∏—Å–æ–≤–∞—Ç—å';
            renderFloorList();
            draw();
            updateSaveBtnState();
        });
        
        li.querySelector('.delete').addEventListener('click', (e) => {
            e.stopPropagation();
            if (savedFloors.length <= 1) {
                alert('–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π —ç—Ç–∞–∂');
                return;
            }
            savedFloors.splice(idx, 1);
            delete sensorPositions[idx];
            delete cameraPositions[idx];
            if (currentViewFloorIdx >= savedFloors.length) {
                currentViewFloorIdx = savedFloors.length - 1;
            }
            points = JSON.parse(JSON.stringify(savedFloors[currentViewFloorIdx] || []));
            renderFloorList();
            saveFloorsToServer();
            draw();
        });
        
        floorList.appendChild(li);
    });
}

function updateSensorsList() {
    const sensorsList = document.getElementById('sensorsList');
    sensorsList.innerHTML = '';
    
    if (Object.keys(sensorsData).length === 0) {
        sensorsList.innerHTML = '<li style="color:#888; padding:10px; font-size:0.9rem;">–ù–µ—Ç –¥–∞—Ç—á–∏–∫–æ–≤</li>';
        return;
    }
    
    const placedSensors = currentViewFloorIdx !== null ? (sensorPositions[currentViewFloorIdx] || {}) : {};
    
    Object.entries(sensorsData).forEach(([sensorId, sData]) => {
        const value = sData ? sData.value : null;
        const isPlaced = sensorId in placedSensors;
        
        const li = document.createElement('li');
        li.className = 'sensor-item' + (isPlaced ? ' placed' : '');
        li.draggable = !isPlaced;
        li.innerHTML = `
            <strong>${sensorId}</strong><br>
            ${value !== null ? value.toFixed(1) + '¬∞C' : '‚Äî'}
            ${isPlaced ? '<br><small>‚úì –Ω–∞ —Å—Ö–µ–º–µ</small>' : ''}
            <button class="remove-btn" title="–£–±—Ä–∞—Ç—å">‚úï</button>
        `;
        
        if (isPlaced) {
            li.querySelector('.remove-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                delete sensorPositions[currentViewFloorIdx][sensorId];
                saveSensorPositionsToServer(currentViewFloorIdx);
                updateSensorsList();
                draw();
            });
        }
        
        li.addEventListener('dragstart', (e) => {
            if (isPlaced) { e.preventDefault(); return; }
            e.dataTransfer.setData('text/plain', JSON.stringify({type: 'sensor', id: sensorId}));
        });
        
        sensorsList.appendChild(li);
    });
}

function updateCamerasList() {
    const camerasList = document.getElementById('camerasList');
    camerasList.innerHTML = '';
    
    if (Object.keys(camerasData).length === 0) {
        camerasList.innerHTML = '<li style="color:#888; padding:10px; font-size:0.9rem;">–ù–µ—Ç –∫–∞–º–µ—Ä</li>';
        return;
    }
    
    const placedCameras = currentViewFloorIdx !== null ? (cameraPositions[currentViewFloorIdx] || {}) : {};
    
    Object.entries(camerasData).forEach(([cameraId, cData]) => {
        const count = cData ? cData.count : 0;
        const isPlaced = cameraId in placedCameras;
        
        const li = document.createElement('li');
        li.className = 'camera-item' + (isPlaced ? ' placed' : '');
        li.draggable = !isPlaced;
        li.innerHTML = `
            <strong>${cameraId}</strong><br>
            üë• ${count} —á–µ–ª.
            ${isPlaced ? '<br><small>‚úì –Ω–∞ —Å—Ö–µ–º–µ</small>' : ''}
            <button class="watch-btn" title="–°–º–æ—Ç—Ä–µ—Ç—å –≤–∏–¥–µ–æ">üëÅÔ∏è –°–º–æ—Ç—Ä–µ—Ç—å</button>
            <button class="remove-btn" title="–£–±—Ä–∞—Ç—å">‚úï</button>
        `;
        
        // –ö–Ω–æ–ø–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤–∏–¥–µ–æ
        li.querySelector('.watch-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            openVideoModal(cameraId);
        });
        
        if (isPlaced) {
            li.querySelector('.remove-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                delete cameraPositions[currentViewFloorIdx][cameraId];
                saveCameraPositionsToServer(currentViewFloorIdx);
                updateCamerasList();
                draw();
            });
        }
        
        li.addEventListener('dragstart', (e) => {
            if (isPlaced) { e.preventDefault(); return; }
            e.dataTransfer.setData('text/plain', JSON.stringify({type: 'camera', id: cameraId}));
        });
        
        camerasList.appendChild(li);
    });
}

// --- –§—É–Ω–∫—Ü–∏–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤–∏–¥–µ–æ —Å –∫–∞–º–µ—Ä—ã ---
let currentWatchingCamera = null;
let videoUpdateCount = 0;
let videoUpdateTimestamp = Date.now();

function openVideoModal(cameraId) {
    currentWatchingCamera = cameraId;
    videoUpdateCount = 0;
    videoUpdateTimestamp = Date.now();
    
    document.getElementById('videoModalCameraId').textContent = cameraId;
    document.getElementById('videoModal').classList.add('active');
    document.getElementById('videoFrame').style.display = 'none';
    document.getElementById('videoNoFrame').style.display = 'flex';
    document.getElementById('videoPersonCount').textContent = '0';
    document.getElementById('videoFps').textContent = '-';
    document.getElementById('videoLastUpdate').textContent = '-';
    
    // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –∫–∞–¥—Ä
    fetchCameraFrame(cameraId);
}

function closeVideoModal() {
    currentWatchingCamera = null;
    document.getElementById('videoModal').classList.remove('active');
}

async function fetchCameraFrame(cameraId) {
    if (!currentWatchingCamera || currentWatchingCamera !== cameraId) return;
    
    try {
        const resp = await fetch(`${API_URL}/camera-stream/${cameraId}`, {headers: apiHeaders()});
        if (resp.ok) {
            const data = await resp.json();
            updateVideoFrame(data);
        }
    } catch (e) {
        console.error('Error fetching camera frame:', e);
    }
    
    // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –µ—Å–ª–∏ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ—Ç–∫—Ä—ã—Ç–æ
    if (currentWatchingCamera === cameraId) {
        setTimeout(() => fetchCameraFrame(cameraId), 200); // 5 FPS –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
    }
}

function updateVideoFrame(data) {
    if (!data || !data.frame) return;
    
    const frameImg = document.getElementById('videoFrame');
    const noFrame = document.getElementById('videoNoFrame');
    
    frameImg.src = 'data:image/jpeg;base64,' + data.frame;
    frameImg.style.display = 'block';
    noFrame.style.display = 'none';
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    document.getElementById('videoPersonCount').textContent = data.count || 0;
    
    // –°—á–∏—Ç–∞–µ–º FPS
    videoUpdateCount++;
    const now = Date.now();
    const elapsed = (now - videoUpdateTimestamp) / 1000;
    if (elapsed >= 1) {
        const fps = (videoUpdateCount / elapsed).toFixed(1);
        document.getElementById('videoFps').textContent = fps;
        videoUpdateCount = 0;
        videoUpdateTimestamp = now;
    }
    
    // –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    const updateTime = new Date(data.timestamp * 1000);
    document.getElementById('videoLastUpdate').textContent = updateTime.toLocaleTimeString();
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
document.getElementById('closeVideoModal').addEventListener('click', closeVideoModal);
document.getElementById('videoModal').addEventListener('click', (e) => {
    if (e.target === document.getElementById('videoModal')) {
        closeVideoModal();
    }
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ WebSocket —Å–æ–±—ã—Ç–∏–π –¥–ª—è –≤–∏–¥–µ–æ
function setupVideoWebSocket() {
    if (!socket) return;
    
    socket.on('camera_frame', (data) => {
        if (data.school_id === SCHOOL_ID && data.camera_id === currentWatchingCamera) {
            updateVideoFrame(data);
        }
    });
}

// --- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è ---
document.getElementById('newFloorBtn').addEventListener('click', () => {
    savedFloors.push([]);
    const newIdx = savedFloors.length - 1;
    points = [];
    currentViewFloorIdx = newIdx;
    editingFloorIdx = newIdx;
    renderFloorList();
    draw();
    updateSaveBtnState();
    saveFloorsToServer();
});

document.getElementById('drawModeBtn').addEventListener('click', () => {
    if (editingFloorIdx === null) {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —ç—Ç–∞–∂ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–∫–Ω–æ–ø–∫–∞ ‚úé)');
        return;
    }
    drawMode = !drawMode;
    document.getElementById('drawModeBtn').textContent = drawMode ? '‚úèÔ∏è –†–∏—Å–æ–≤–∞–Ω–∏–µ: –í–ö–õ' : '‚úèÔ∏è –†–∏—Å–æ–≤–∞—Ç—å';
});

document.getElementById('saveBtn').addEventListener('click', () => {
    if (points.length < 3) {
        alert('–ù–∞—Ä–∏—Å—É–π—Ç–µ –∫–æ–Ω—Ç—É—Ä —ç—Ç–∞–∂–∞ (–º–∏–Ω–∏–º—É–º 3 —Ç–æ—á–∫–∏)');
        return;
    }
    savedFloors[editingFloorIdx] = JSON.parse(JSON.stringify(points));
    editingFloorIdx = null;
    drawMode = false;
    document.getElementById('drawModeBtn').textContent = '‚úèÔ∏è –†–∏—Å–æ–≤–∞—Ç—å';
    renderFloorList();
    saveFloorsToServer();
    draw();
    updateSaveBtnState();
});

document.getElementById('heatmapToggle').addEventListener('change', draw);
document.getElementById('densityToggle').addEventListener('change', draw);

// --- Canvas: —Ä–∏—Å–æ–≤–∞–Ω–∏–µ ---
function isPointInPolygon(x, y, polygon) {
    if (!polygon || polygon.length < 3) return false;
    let inside = false;
    for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
        const xi = polygon[i].x, yi = polygon[i].y;
        const xj = polygon[j].x, yj = polygon[j].y;
        const intersect = ((yi > y) !== (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
        if (intersect) inside = !inside;
    }
    return inside;
}

function interpolateValue(x, y, devices, getValue) {
    if (devices.length === 0) return null;
    if (devices.length === 1) return getValue(devices[0]);
    
    let sumWeights = 0;
    let sumValues = 0;
    const power = 2;
    
    for (const d of devices) {
        const dx = x - d.x;
        const dy = y - d.y;
        const dist = Math.sqrt(dx*dx + dy*dy);
        if (dist < 1) return getValue(d);
        const w = 1 / Math.pow(dist, power);
        const val = getValue(d);
        if (val !== null) {
            sumWeights += w;
            sumValues += w * val;
        }
    }
    return sumWeights > 0 ? sumValues / sumWeights : null;
}

function drawHeatmap(type) {
    if (points.length < 3 || currentViewFloorIdx === null) return;
    
    let devices = [];
    let minVal, maxVal;
    
    if (type === 'temperature') {
        const floorSensors = sensorPositions[currentViewFloorIdx] || {};
        for (const [sensorId, pos] of Object.entries(floorSensors)) {
            const sData = sensorsData[sensorId];
            if (sData && sData.value !== null) {
                devices.push({x: pos.x, y: pos.y, value: sData.value});
            }
        }
        if (devices.length === 0) return;
        const vals = devices.map(d => d.value);
        minVal = Math.min(...vals);
        maxVal = Math.max(...vals);
        if (maxVal - minVal < 0.1) { minVal -= 5; maxVal += 5; }
    } else {
        const floorCameras = cameraPositions[currentViewFloorIdx] || {};
        for (const [cameraId, pos] of Object.entries(floorCameras)) {
            const cData = camerasData[cameraId];
            devices.push({x: pos.x, y: pos.y, value: cData ? cData.count : 0});
        }
        if (devices.length === 0) return;
        const vals = devices.map(d => d.value);
        minVal = 0;
        maxVal = Math.max(1, Math.max(...vals));
    }
    
    const xs = points.map(p => p.x);
    const ys = points.map(p => p.y);
    const minX = Math.floor(Math.min(...xs));
    const maxX = Math.ceil(Math.max(...xs));
    const minY = Math.floor(Math.min(...ys));
    const maxY = Math.ceil(Math.max(...ys));
    
    const step = 8;
    
    for (let y = minY; y <= maxY; y += step) {
        for (let x = minX; x <= maxX; x += step) {
            if (isPointInPolygon(x, y, points)) {
                const val = interpolateValue(x, y, devices, d => d.value);
                if (val === null) continue;
                
                const ratio = Math.max(0, Math.min(1, (val - minVal) / (maxVal - minVal)));
                let hue;
                if (type === 'temperature') {
                    hue = (1 - ratio) * 240; // —Å–∏–Ω–∏–π -> –∫—Ä–∞—Å–Ω—ã–π
                } else {
                    hue = (1 - ratio) * 120; // –∑–µ–ª—ë–Ω—ã–π -> –∫—Ä–∞—Å–Ω—ã–π
                }
                
                ctx.fillStyle = `hsla(${hue}, 80%, 50%, 0.3)`;
                ctx.fillRect(x, y, step, step);
            }
        }
    }
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // –¢–µ–ø–ª–æ–≤—ã–µ –∫–∞—Ä—Ç—ã (—Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞)
    if (editingFloorIdx === null && points.length > 2) {
        if (document.getElementById('heatmapToggle').checked) {
            drawHeatmap('temperature');
        }
        if (document.getElementById('densityToggle').checked) {
            drawHeatmap('density');
        }
    }
    
    // –ö–æ–Ω—Ç—É—Ä —ç—Ç–∞–∂–∞
    if (points.length > 1) {
        ctx.beginPath();
        ctx.moveTo(points[0].x, points[0].y);
        for (let i = 1; i < points.length; i++) {
            ctx.lineTo(points[i].x, points[i].y);
        }
        if (points.length > 2) ctx.lineTo(points[0].x, points[0].y);
        ctx.strokeStyle = editingFloorIdx !== null ? '#0074D9' : '#333';
        ctx.lineWidth = editingFloorIdx !== null ? 5 : 3;
        ctx.stroke();
    }
    
    // –¢–æ—á–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    if (editingFloorIdx !== null) {
        for (let i = 0; i < points.length; i++) {
            const p = points[i];
            ctx.beginPath();
            ctx.fillStyle = i === selectedIdx ? '#2ECC40' : '#FF4136';
            ctx.fillRect(p.x - RADIUS, p.y - RADIUS, RADIUS * 2, RADIUS * 2);
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.strokeRect(p.x - RADIUS, p.y - RADIUS, RADIUS * 2, RADIUS * 2);
        }
    }
    
    // –î–∞—Ç—á–∏–∫–∏ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã
    if (currentViewFloorIdx !== null) {
        const floorSensors = sensorPositions[currentViewFloorIdx] || {};
        for (const [sensorId, pos] of Object.entries(floorSensors)) {
            const sData = sensorsData[sensorId];
            const value = sData ? sData.value : null;
            
            let fillColor = '#667eea';
            if (value !== null) {
                const ratio = Math.max(0, Math.min(1, (value - 10) / 40));
                const hue = (1 - ratio) * 240;
                fillColor = `hsl(${hue}, 85%, 55%)`;
            }
            
            ctx.beginPath();
            ctx.arc(pos.x, pos.y, SENSOR_RADIUS, 0, Math.PI * 2);
            ctx.fillStyle = fillColor;
            ctx.fill();
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 3;
            ctx.stroke();
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 1;
            ctx.stroke();
            
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 10px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(value !== null ? `${value.toFixed(0)}¬∞` : '?', pos.x, pos.y);
        }
        
        // –ö–∞–º–µ—Ä—ã
        const floorCameras = cameraPositions[currentViewFloorIdx] || {};
        for (const [cameraId, pos] of Object.entries(floorCameras)) {
            const cData = camerasData[cameraId];
            const count = cData ? cData.count : 0;
            
            // –¶–≤–µ—Ç –∫–∞–º–µ—Ä—ã –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –ª—é–¥–µ–π
            let fillColor = '#27ae60'; // –∑–µ–ª—ë–Ω—ã–π - –º–∞–ª–æ –ª—é–¥–µ–π
            if (count > 10) fillColor = '#e74c3c'; // –∫—Ä–∞—Å–Ω—ã–π - –º–Ω–æ–≥–æ
            else if (count > 5) fillColor = '#f39c12'; // –æ—Ä–∞–Ω–∂–µ–≤—ã–π - —Å—Ä–µ–¥–Ω–µ
            
            // –ò–∫–æ–Ω–∫–∞ –∫–∞–º–µ—Ä—ã (–∫–≤–∞–¥—Ä–∞—Ç —Å–æ —Å–∫—Ä—É–≥–ª—ë–Ω–Ω—ã–º–∏ —É–≥–ª–∞–º–∏)
            ctx.beginPath();
            ctx.roundRect(pos.x - CAMERA_RADIUS, pos.y - CAMERA_RADIUS/1.5, CAMERA_RADIUS * 2, CAMERA_RADIUS * 1.3, 5);
            ctx.fillStyle = fillColor;
            ctx.fill();
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            // –õ–∏–Ω–∑–∞ –∫–∞–º–µ—Ä—ã
            ctx.beginPath();
            ctx.arc(pos.x, pos.y - 2, 6, 0, Math.PI * 2);
            ctx.fillStyle = '#333';
            ctx.fill();
            ctx.beginPath();
            ctx.arc(pos.x, pos.y - 2, 3, 0, Math.PI * 2);
            ctx.fillStyle = '#fff';
            ctx.fill();
            
            // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª—é–¥–µ–π –ø–æ–¥ –∫–∞–º–µ—Ä–æ–π
            ctx.fillStyle = '#333';
            ctx.font = 'bold 12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(`üë• ${count}`, pos.x, pos.y + CAMERA_RADIUS + 12);
        }
    }
}

// --- Canvas: –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ ---
function getPointIdx(x, y) {
    return points.findIndex(p => (p.x - x) ** 2 + (p.y - y) ** 2 < RADIUS ** 2);
}

function getDeviceAtPos(x, y) {
    if (currentViewFloorIdx === null) return null;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞—Ç—á–∏–∫–∏
    const floorSensors = sensorPositions[currentViewFloorIdx] || {};
    for (const [sensorId, pos] of Object.entries(floorSensors)) {
        if ((pos.x - x) ** 2 + (pos.y - y) ** 2 < SENSOR_RADIUS ** 2 * 1.5) {
            return {type: 'sensor', id: sensorId, pos: pos};
        }
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–º–µ—Ä—ã
    const floorCameras = cameraPositions[currentViewFloorIdx] || {};
    for (const [cameraId, pos] of Object.entries(floorCameras)) {
        if (Math.abs(pos.x - x) < CAMERA_RADIUS * 1.5 && Math.abs(pos.y - y) < CAMERA_RADIUS) {
            return {type: 'camera', id: cameraId, pos: pos};
        }
    }
    
    return null;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç —Å —É—á—ë—Ç–æ–º –º–∞—Å—à—Ç–∞–±–∞ canvas
function getCanvasCoords(e) {
    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    return {
        x: (e.clientX - rect.left) * scaleX,
        y: (e.clientY - rect.top) * scaleY
    };
}

canvas.addEventListener('mousedown', e => {
    const coords = getCanvasCoords(e);
    let x = coords.x;
    let y = coords.y;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–ª–∏–∫ –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –¥–ª—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
    const device = getDeviceAtPos(x, y);
    if (device && editingFloorIdx === null) {
        draggingDevice = device.id;
        draggingDeviceType = device.type;
        draggingDeviceOffset = {x: device.pos.x - x, y: device.pos.y - y};
        canvas.style.cursor = 'grabbing';
        return;
    }
    
    // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ—á–µ–∫ –∫–æ–Ω—Ç—É—Ä–∞
    const idx = getPointIdx(x, y);
    if (idx !== -1 && editingFloorIdx !== null) {
        draggingIdx = idx;
        selectedIdx = idx;
        offset = {x: points[idx].x - x, y: points[idx].y - y};
        draw();
    } else if (drawMode && editingFloorIdx !== null) {
        if (points.length > 0) {
            const prev = points[points.length - 1];
            if (Math.abs(x - prev.x) < Math.abs(y - prev.y)) x = prev.x;
            else y = prev.y;
        }
        points.push({x, y});
        selectedIdx = points.length - 1;
        draw();
    } else {
        selectedIdx = null;
        draw();
    }
});

canvas.addEventListener('mousemove', e => {
    const coords = getCanvasCoords(e);
    let x = coords.x;
    let y = coords.y;
    
    // –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
    if (draggingDevice && currentViewFloorIdx !== null) {
        const newX = x + draggingDeviceOffset.x;
        const newY = y + draggingDeviceOffset.y;
        
        if (points.length >= 3 && isPointInPolygon(newX, newY, points)) {
            if (draggingDeviceType === 'sensor') {
                sensorPositions[currentViewFloorIdx][draggingDevice] = {x: newX, y: newY};
            } else {
                cameraPositions[currentViewFloorIdx][draggingDevice] = {x: newX, y: newY};
            }
            draw();
        }
        return;
    }
    
    // –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ —Ç–æ—á–∫–∏ –∫–æ–Ω—Ç—É—Ä–∞
    if (draggingIdx !== null && editingFloorIdx !== null) {
        x = x + offset.x;
        y = y + offset.y;
        const SNAP_DIST = 15;
        for (let i = 0; i < points.length; i++) {
            if (i === draggingIdx) continue;
            if (Math.abs(x - points[i].x) < SNAP_DIST) x = points[i].x;
            if (Math.abs(y - points[i].y) < SNAP_DIST) y = points[i].y;
        }
        points[draggingIdx] = {x, y};
        draw();
    }
});

canvas.addEventListener('mouseup', () => {
    if (draggingDevice && currentViewFloorIdx !== null) {
        if (draggingDeviceType === 'sensor') {
            saveSensorPositionsToServer(currentViewFloorIdx);
        } else {
            saveCameraPositionsToServer(currentViewFloorIdx);
        }
        draggingDevice = null;
        draggingDeviceType = null;
        canvas.style.cursor = 'crosshair';
    }
    draggingIdx = null;
});

canvas.addEventListener('mouseleave', () => {
    if (draggingDevice) {
        if (draggingDeviceType === 'sensor') {
            saveSensorPositionsToServer(currentViewFloorIdx);
        } else {
            saveCameraPositionsToServer(currentViewFloorIdx);
        }
        draggingDevice = null;
        draggingDeviceType = null;
        canvas.style.cursor = 'crosshair';
    }
    draggingIdx = null;
});

// Drag & Drop —Å –ø–∞–Ω–µ–ª–∏
canvas.addEventListener('dragover', e => e.preventDefault());

canvas.addEventListener('drop', e => {
    e.preventDefault();
    if (currentViewFloorIdx === null) return;
    
    try {
        const data = JSON.parse(e.dataTransfer.getData('text/plain'));
        const coords = getCanvasCoords(e);
        const x = coords.x;
        const y = coords.y;
        
        if (points.length >= 3 && isPointInPolygon(x, y, points)) {
            if (data.type === 'sensor') {
                if (!sensorPositions[currentViewFloorIdx]) sensorPositions[currentViewFloorIdx] = {};
                sensorPositions[currentViewFloorIdx][data.id] = {x, y};
                saveSensorPositionsToServer(currentViewFloorIdx);
                updateSensorsList();
            } else if (data.type === 'camera') {
                if (!cameraPositions[currentViewFloorIdx]) cameraPositions[currentViewFloorIdx] = {};
                cameraPositions[currentViewFloorIdx][data.id] = {x, y};
                saveCameraPositionsToServer(currentViewFloorIdx);
                updateCamerasList();
            }
            draw();
        } else {
            alert('–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –º–æ–∂–Ω–æ —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç—É—Ä–∞ —ç—Ç–∞–∂–∞!');
        }
    } catch (err) {
        console.error('Drop error:', err);
    }
});

document.addEventListener('keydown', e => {
    if ((e.key === 'Delete' || e.key === 'Backspace') && selectedIdx !== null && editingFloorIdx !== null) {
        points.splice(selectedIdx, 1);
        selectedIdx = null;
        draw();
    }
});

// --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
(async function init() {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—É—é —Å–µ—Å—Å–∏—é
    const savedToken = localStorage.getItem('jwt_token');
    const savedSchoolId = localStorage.getItem('school_id');
    const savedSchoolName = localStorage.getItem('school_name');
    
    if (savedToken && savedSchoolId) {
        JWT_TOKEN = savedToken;
        SCHOOL_ID = savedSchoolId;
        SCHOOL_NAME = savedSchoolName || savedSchoolId;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å —Ç–æ–∫–µ–Ω–∞
        try {
            const resp = await fetch(`${API_URL}/health`);
            if (resp.ok) {
                showMainScreen();
                return;
            }
        } catch (e) {}
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    document.getElementById('authScreen').style.display = 'flex';
})();
</script>
</body>
</html>
